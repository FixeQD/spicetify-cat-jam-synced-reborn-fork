name: Auto Build

on:
    push:
        branches:
            - main
        paths:
            - 'package.json'
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 2 # Need historical context to compare versions

            - name: Check version change
              id: check
              run: |
                  # If it's a manual trigger, always build
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  CURR_VER=$(jq -r .version package.json)
                  PREV_VER=$(git show HEAD~1:package.json | jq -r .version || echo "0.0.0")

                  if [ "$CURR_VER" != "$PREV_VER" ]; then
                    echo "Version changed from $PREV_VER to $CURR_VER. Proceeding with build."
                    echo "changed=true" >> $GITHUB_OUTPUT
                  else
                    echo "Version unchanged ($CURR_VER). Skipping build."
                    echo "changed=false" >> $GITHUB_OUTPUT
                  fi

            - uses: oven-sh/setup-bun@v2
              if: steps.check.outputs.changed == 'true'
              with:
                  bun-version: latest

            - name: Install dependencies
              if: steps.check.outputs.changed == 'true'
              run: bun install

            - name: Build project
              if: steps.check.outputs.changed == 'true'
              run: bun run build

            - name: Commit and push changes
              if: steps.check.outputs.changed == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add dist/cat-jam.js
                  # Only commit if dist actually changed
                  if ! git diff --staged --quiet; then
                    git commit -m "build: automatic extension bundle update (v$(jq -r .version package.json))"
                    git push
                  else
                    echo "No changes in dist/cat-jam.js to commit."
                  fi
